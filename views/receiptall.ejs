<%- include('nav bar/navbar.ejs') %>
    <title>ITEM Database</title>
    <link rel='stylesheet' href='/stylesheets/productallstyle.css' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<style>
 /* Style the dropdown button */
.dropbtn {
  background-color: #3d5095;
  color: white;
  padding: 12px 20px;
  font-size: 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
  margin-right: 20px;
  width: 180px;
}

/* Change color of dropdown button on hover */
.dropbtn:hover {
  background-color: #4566a0;
}

/* Style the dropdown content */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
  border-radius: 4px;
}

/* Style the dropdown links */
.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  transition: background-color 0.3s;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {
  background-color: #ddd;
}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
  display: block;
}

/* Style the dropdown on hover */
.dropdown:hover .dropbtn {
  background-color: #4578a0;
}

</style>

    <main class="table">
      <% var finalsecurity = 0 %>
        <section class="table__header">
            <div class="custom-container">
              <div class="dropdown">
                <% var all = 0; %>
                <% var flag = 0; %>
                <% var clear = 0; %>
                <% var transport = 0; %>
                <% var dropbox = 0; %>
                <% allproducts.forEach(product => { %>

                  <% if (product.final !== 1 && product.dropbox  !== 'on') { %>
                  <%  all++; %>
                  <% if (product.flag == 'on') { %>

                    <%  flag++; %>
                  <% } %>
                  <% if (product.transport == 'on') { %>

                    <%  transport++; %>
                  <% } %>
                  <% } %>
                  <% if (product.final == 1) { %>
                    <%  clear++; %>
                    <% } %>
                    <% if (product.dropbox  == 'on') { %>
                      <%  dropbox++; %>
                      <% } %>

                  <% }) %>
                <button class="dropbtn">Product Database</button>
                <div class="dropdown-content">
                  <a href="/ttreceiptall">Product Database - <%= all %></a>
                  <a href="/ttreceiptflagall">Flag Orders - <%= flag %></a>
                  <a href="/ttreceipttransportall">Transport Order's - <%= transport %></a>
                  <a href="/ttreceiptdropboxall">Dropbox Order's - <%= dropbox %></a>
                  <a href="/ttsortall">Sorted Order's </a>
                  <a href="/ttreceiptclearall">Clear Order's - <%= totalNonFiltered %></a>
                </div>

              </div>
            
              
              <style>
               
                .hide {
                    display: none;
                }
                .result-count {
                    margin-top: 10px;
                }
            </style>
                
              
              <a href="/printall" class="custom-link" target="_blank">
                  <i class="fa-solid fa-print fa-fw"></i> 
              </a>
              
              <style>
              .custom-link {
                  display: inline-flex;
                  align-items: center;
                  gap: 8px; /* Space between icon and text */
                  text-decoration: none;
                  color: #333; /* Default icon color */
                  font-size: 18px;
                  padding: 8px 12px;
                  border-radius: 6px;
                  
                  border: 1px solid #ddd;
                  transition: all 0.3s ease-in-out;
                  margin: 5px 0; /* Space between buttons */
              }
              
              .custom-link:hover {
                  background: #007bff;
                  color: #fff;
                  border-color: #007bff;
              }
              
              .custom-link i {
                  transition: transform 0.2s ease-in-out;
              }
              
              .custom-link:hover i {
                  transform: scale(1.1); /* Slight zoom on hover */
              }
              
              </style>
              
              
            
              
              
              
            </div>
            
            <div class="result-count"></div>
            <div class="input-group">
                <input type="search" placeholder="Search Data...">
                <img src="images/search.png" alt="">
            </div>
        </section>
        <% function calculateDaysSinceOrder(orderDate) { %>
            <% const currentDate = new Date(); %>
            <% const orderDateObj = new Date(orderDate); %>
            <% const timeDifference = currentDate.getTime() - orderDateObj.getTime(); %>
            <% const daysDifference = (Math.floor(timeDifference / (1000 * 60 * 60 * 24))+2); %>
            <% return daysDifference; %>
        <% } %>
        <section class="table__body">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th data-sort-type="numeric"> #<span class="icon-arrow">&UpArrow;</span> </th>
                        <th> Date<span class="icon-arrow">&UpArrow;</span> </th>
                        <th data-sort-type="string"> Client Info <span class="icon-arrow">&UpArrow;</span></th>

                        
                        <th data-sort-type="numeric"> Order Info <span class="icon-arrow">&UpArrow;</span></th>
                        <th data-sort-type="numeric"> Days </th>
                        <th data-sort-type="string"> Action <span class="icon-arrow">&UpArrow;</span></th>
                    </tr>
                </thead>
                <% if (allproducts && allproducts.length > 0) { %>
                 
                    <tbody>
                        <tr>
                            <% let serialNumber = 1; %>
                           
                            <%
                            let productsToShow = allproducts;
                            if (typeof currentMonth === 'undefined' || typeof currentYear === 'undefined') {
                              productsToShow = allproducts.slice().reverse();
                            }
                          %>
                          
                          <% productsToShow.forEach(product => { %>



                          <% if ( product.dropbox  !== 'on' || product.dropbox  == 'on') { %>



                            <td style="width: 20px;"><div><%= serialNumber++ %></div>
                              <% if (product.callafter) { %><div>C.A.</div><div><%= product.callafter %> days</div><% } %></td>
                          
                            <td style="width: 130px;">
                                <%= product.receiptChallannumber %><br style="margin-bottom: 10px;">
                                <% if (product.receiptdate && !isNaN(new Date(product.receiptdate))) { %>
                             <%= new Date(product.receiptdate).toLocaleString('en-GB', {
  timeZone: 'UTC',   // prevent unwanted shift
  day:    '2-digit',
  month:  'short',
  year:   'numeric',
  hour:   '2-digit',
  minute: '2-digit',
  hour12: false
}) %>

                                <% } else { %>
                                  <strong>Order date:</strong><br>
                                  <em>N/A</em>
                                <% } %>
                                
                             
                                <% if( product.Attachorderno) { %>}
                                <strong>Attach Order no  <%= product.Attachorderno %></strong><% } %>
                              </td>
                           
                            <td >
     <!-- üåê Optional: Font Awesome for modern icons (optional but recommended) -->
<!-- Uncomment the line below if you want to use FA icons instead -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> -->
<!-- Include Font Awesome once -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  .label {
    font-weight: 600;
    color: #030303;
  }

  .copyIcon {
    cursor: pointer;
    color: #939393;
    font-size: .5em;
    user-select: none;
    margin-left: 10px;
    transition: all 0.3s ease;
  }

  .copyIcon.success {
    color: rgb(0, 0, 0);
    transform: scale(1.3);
  }

  .clientText {
    font-weight: 400;
    color: #000000;
   
  }
</style>

<!-- EJS Template for one product -->
<div class="client-block" style="margin-bottom: 15px;">
  <h4>
    Client Info
    <span class="copyIcon" onclick="copyClientInfo(this)" title="Copy to Clipboard">
      <i class="fa-regular fa-copy"></i>
    </span>
  </h4>

  <div class="clientText">
    <% if (product.receiptclientname) { %>
      <span class="label">Name:</span> <%= product.receiptclientname.clientName %><br>
      <span class="label">Address:</span> <%= product.receiptclientname.address %><br>
      <span class="label">Phone:</span> <%= product.receiptclientname.phone %><br>

      <% if (product.receiptclientsitename) { %>
        <span class="label">Name:</span> <%= product.receiptclientsitename.clientNamesite %><br>
        <span class="label">Address:</span> <%= product.receiptclientsitename.phonesite %><br>
        <span class="label">Phone:</span> <%= product.receiptclientsitename.addresssite %><br>
      <% } %>
    <% } else { %>
      <em>Client information not available</em>
    <% } %>
  </div>
</div>

<script>
function copyClientInfo(iconElement) {
  const clientDiv = iconElement.closest('.client-block').querySelector('.clientText');

  let text = clientDiv.innerHTML
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<[^>]*>/g, '')
    .replace(/\n{2,}/g, '\n')
    .replace(/[ \t]+/g, ' ')
    .trim();

  navigator.clipboard.writeText(text).then(() => {
    iconElement.classList.add("success");
    iconElement.innerHTML = "‚úÖ";
    setTimeout(() => {
      iconElement.classList.remove("success");
      iconElement.innerHTML = '<i class="fa-regular fa-copy"></i>';
    }, 2000);
  }).catch(err => {
    iconElement.innerHTML = "‚ùå";
    setTimeout(() => {
      iconElement.innerHTML = '<i class="fa-regular fa-copy"></i>';
    }, 2000);
  });
}
</script>







                                
                                <div class="item-container">
                                  <div class="item-header">
                                    <% if (product.transportinfo && product.transportinfo !== "Self" && product.transportinfo !== "on" && product.transportinfo !== "off") { %>
                                      <div><%= product.transportinfo %></div>
                                    <% } %>
                                  </div>
                                </div>
                                <div class="item-container">
                                  <div class="item-header">
                                    <% if (product.final == 1) { %>
                                      <div style="color: red; font-weight: bold; background-color: #ffe6e6; padding: 5px; border-radius: 5px;">
                                        Account Clear
                                      </div>
                                    <% } %>
                                  </div>
                                </div>
                                <div>
                                  <% 
  let finalAmount = 0;

  if (product.generalitemreceipt && Array.isArray(product.generalitemreceipt)) {
    product.generalitemreceipt.forEach(item => {
      let ongoing = item.onngoing || [];
      let totalin = 0;
      ongoing.forEach(itemm => {
        totalin += parseInt(itemm.quantity, 10);
      });

      if (totalin === 0) {
        const dateString1 = item.Dateandtime;
        const dateObject1 = new Date(dateString1);
        if (!isNaN(dateObject1)) {
          dateObject1.setUTCHours(0, 0, 0, 0);
          const currentDate = new Date();
          const istOffset = 5.5 * 60 * 60 * 1000;
          const millisecondsDifference = (currentDate.getTime() + istOffset) - dateObject1.getTime();
          let daysDifference = Math.floor(millisecondsDifference / (24 * 60 * 60 * 1000));
          finalAmount += item.Quantity * item.rent * (daysDifference + 1);
        }
      } else if (totalin > 0) {
        let checkno = totalin === item.Quantity ? ongoing.length : ongoing.length + 1;
        let workingquantity = item.Quantity;
        for (let i = 0; i < checkno; i++) {
          let startDate;
          if (i === 0) {
            startDate = new Date(item.Dateandtime);
          } else {
            const returnDate = ongoing[i - 1]?.returndateAt;
            startDate = returnDate && !isNaN(new Date(returnDate)) ? new Date(returnDate) : new Date();
          }

          if (!isNaN(startDate)) {
            startDate.setUTCHours(0, 0, 0, 0);
            let segmentEndDate = (ongoing[i] && ongoing[i].returndateAt)
              ? new Date(ongoing[i].returndateAt)
              : new Date();

            if (!isNaN(segmentEndDate)) {
              const millisecondsDifference = segmentEndDate.getTime() - startDate.getTime();
              let days = Math.floor(millisecondsDifference / (24 * 60 * 60 * 1000));
              let segmentAmount = item.rent * workingquantity * (ongoing[i]?.mtTick === 'on' ? days + 1 : days);
              finalAmount += segmentAmount;
              if (ongoing[i]) {
                workingquantity -= ongoing[i].quantity;
              }
            }
          }
        }
      }
    });
  }

  // =========================
  // Process Farma Items
  // =========================
  if (product.farmaitemreceipt && Array.isArray(product.farmaitemreceipt)) {
    product.farmaitemreceipt.forEach(item => {
      let totalin = 0;
      if (item.ongoing && Array.isArray(item.ongoing)) {
        item.ongoing.forEach(itemm => {
          let num = parseInt(itemm.noofsetsfarma, 10) || 0;
          totalin += num;
        });
      }

      if (totalin === 0) {
        const dateString1 = item.Dateandtimefarma;
        const dateObject1 = new Date(dateString1);
        if (!isNaN(dateObject1)) {
          dateObject1.setUTCHours(0, 0, 0, 0);
          const currentDate = new Date();
          const istOffset = 5.5 * 60 * 60 * 1000;
          const millisecondsDifference = (currentDate.getTime() + istOffset) - dateObject1.getTime();
          let daysDifference = Math.floor(millisecondsDifference / (24 * 60 * 60 * 1000));
          finalAmount += item.rentpersetfarma * item.noofsetsfarma * (daysDifference + 1);
        }
      } else if (totalin > 0) {
        let checkno = totalin === item.noofsetsfarma ? item.ongoing.length : item.ongoing.length + 1;
        let workingquantity = item.noofsetsfarma;
        for (let i = 0; i < checkno; i++) {
          let startDate;
          if (i === 0) {
            startDate = new Date(item.Dateandtimefarma);
          } else {
            const returnDate = item.ongoing[i - 1]?.returndateAt;
            startDate = returnDate && !isNaN(new Date(returnDate)) ? new Date(returnDate) : new Date();
          }

          if (!isNaN(startDate)) {
            startDate.setUTCHours(0, 0, 0, 0);
            let segmentEndDate = (item.ongoing && item.ongoing[i] && item.ongoing[i].returndateAt)
              ? new Date(item.ongoing[i].returndateAt)
              : new Date();

            if (!isNaN(segmentEndDate)) {
              const millisecondsDifference = segmentEndDate.getTime() - startDate.getTime();
              let days = Math.floor(millisecondsDifference / (24 * 60 * 60 * 1000));
              let segmentAmount = item.rentpersetfarma * workingquantity * (item.ongoing[i]?.mtTick === 'on' ? days + 1 : days);
              finalAmount += segmentAmount;
              if (item.ongoing && i < item.ongoing.length) {
                workingquantity -= item.ongoing[i].noofsetsfarma;
              }
            }
          }
        }
      }
    });
  }
%>

                                
                                </div>
                                
                                
                                
                                
                              </td>

                              <td style="width: 490px;">
                                <div class="item-container">
                                  <div class="item-header">
                                    <div>Item Name</div>
                                    <div>Quantity</div>
                                    <div>Rent</div>
                                  </div>
                                  
                                  <div class="item-body">
                                    <% product.generalitemreceipt.forEach(item => { %>
                                      <div class="item-row">
                                        <% var inquantity = 0 %>
                                        <% if (item) { %>
                                          <div><%= item.itemoutname %></div>
                                          <% if (item.onngoing == 0) { %>
                                            <div><%= item.Quantity %></div>
                                          <% } else { %>
                                            <% item.onngoing.forEach(itemm => { %>
                                              <% inquantity += itemm.quantity; %>
                                            <% }); %>
                                            
                                            <div><%= item.Quantity %>  <%= inquantity %> </div>
                                          <% } %>
                                          <div><%= item.rent %></div>
                                        <% } else { %>
                                          <div colspan="3"><em>Item information not available</em></div>
                                        <% } %>
                                      </div>
                                    <% }); %>
                                  </div>
                                

                                  <div>
                                    <% product.scaffoldingitemreceipt.forEach(itemm => { %>
                                      <div>
                                        <% if (itemm) { %>
                                          <div class="item-row">
                                            <div>
                                              Scaffolding <%= itemm.lengthoutscaffolding %>'X<%= itemm.heightoutscaffolding %>'X<%= itemm.breadthscaffolding %>'
                                              <% if (itemm.cuplock10ftno) { %>
                                                <div>Cuplock 10' : <%= itemm.cuplock10ftno %></div>
                                                <% } %>    <% if (itemm.cuplock5ftno) { %>
                                                  <div>Cuplock 5': <%= itemm.cuplock5ftno %></div>
                                                <% } %>
                                                <% if (itemm.cuplock8ftno) { %> 
                                                  <div>Cuplock 8' : <%= itemm.cuplock8ftno %></div>
                                                <% } %>
                                                <% if (itemm.ledger5ftno) { %>
                                                  <div>Ledger 5' : <%= itemm.ledger5ftno %></div>
                                                <% } %>
                                                <% if (itemm.ledger3ftno) { %>
                                                  <div>Ledger 3': <%= itemm.ledger3ftno %></div>
                                                <% } %>
                                                <% if (itemm.ledger6ft5inchno) { %>
                                                  <div>Ledger 6'6" :<%= itemm.ledger6ft5inchno %></div>
                                                <% } %>
                                                <% if (itemm.pinscaffoldingno) { %>
                                                  <div>Pin : <%= itemm.pinscaffoldingno %></div>
                                                <% } %>
                                                <% if (itemm.woodernchaliscaffolding) { %>
                                                  <div>Woodern Chali:<%= itemm.woodernchaliscaffolding %></div>
                                                <% } %>
                                                <% if (itemm.steelchalscaffolding) { %>
                                                  <div>Steel chali:<%= itemm.steelchalscaffolding %></div>
                                                <% } %>
                                                <% if (itemm.wheelscaffolding) { %>
                                                  <div>Wheel jack : <%= itemm.wheelscaffolding %></div>
                                                <% } %>
                                              
                                            </div>


                                            <div><%= itemm.quantityscaffolding %> Set
                                            </div>

<% if(itemm.numberofdayscaffolding==1) {%>
  
  <div>
    <%= itemm.rentmultipledayscaffolding %> per day
    
 </div>
 <% } else { %>
                                            <div>
                                             <%= itemm.rentmultipledayscaffolding %> for <%= itemm.numberofdayscaffolding %> days then <%= itemm.rateafterdayscaffolding %> per day
                                             
                                          </div>
<% } %>

                                          </div>


                                        <% } %>
                                      </div>
                                    <% }); %>
                              
                                    <% product.farmaitemreceipt.forEach(itemm => { %>
                                      <% if (itemm) { %>
                                        <div class="item-row">
                                          <div>Farma <%= itemm.length1farma %> X <%= itemm.length2farma %> (<%= itemm.heightfarma %>)</div>
                                          <div><%= itemm.noofsetsfarma %> Set
                                          
                                            <%  if(itemm.plate9inchfarma) {   %>
                                              <div> Plate9" : <%= itemm.plate9inchfarma %></div>
                                            <% } %>
                                            <%  if(itemm.plate12inchfarma) {   %>
                                              <div>Plate12" : <%= itemm.plate12inchfarma %></div>
                                            <% } %>
                                            <%  if(itemm.plate15inchfarma) {   %>
                                              <div>Plate15" : <%= itemm.plate15inchfarma %></div>
                                            <% } %>
                                            <%  if(itemm.plate18inchfarma) {   %>
                                              <div>Plate18" : <%= itemm.plate18inchfarma %></div>
                                            <% } %>
                                            <%  if(itemm.plate21inchfarma) {   %>
                                              <div>Plate21" : <%= itemm.plate21inchfarma %></div>
                                            <% } %>
                                            <%  if(itemm.plate24inchfarma) {   %>
                                              <div>Plate24" : <%= itemm.plate24inchfarma %></div>
                                            <% } %>
                                            <%  if(itemm.plate27inchfarma) {   %>
                                              <div>Plate27" : <%= itemm.plate27inchfarma %></div>
                                            <% } %>
                                          </div>
                                          <div><%= itemm.rentpersetfarma %></div>
                                        </div>
                                      <% } %>
                                    <% }); %>
                                  </div>

                                  <div class="item-row">
                                    <% if (product.nutboltfarma || product.keyfarma) { %>
                                      <div>
                                        <% if (product.nutboltfarma) { %>
                                          Nut bolt : <%= product.nutboltfarma %>
                                        <% } %>
                                        <% if (product.nutboltfarma && product.keyfarma) { %><br><% } %>
                                        <% if (product.keyfarma) { %>
                                          Spanner : <%= product.keyfarma %>
                                        <% } %>
                                      </div>
                                    <% } %>
                                  </div>


                                  <div class="item-row">
                                    <% if (product.additionalcharges && product.additionalcharges.length > 0) { %>
                                      <%
                                      // Initialize the combined string and total cost
                                      let combinedString = "";
                                      let totalCost = 0;
                                  
                                      // Build the combined string and accumulate the total cost
                                      product.additionalcharges.forEach((itemmm, index) => {
                                        if (index > 0) {
                                          combinedString += " + ";
                                        }
                                        combinedString += itemmm.additionalchargesName + " (Rs " + itemmm.additionalchargesCost + ")";
                                        totalCost += parseFloat(itemmm.additionalchargesCost); // Assuming additionalchargesCost is a number or can be parsed as a float
                                      });
                                      %>
                                      <div>
                                        Additional charges : 
                                        <%= combinedString %> = 
                                        Rs <%= totalCost %>
                                      </div>
                                    
                                    <% } %>
                                  </div>
                                  <div class="item-row">
                                    <% if (product.comment) { %>
                                      <div> 
                                          COMMENT : <%= product.comment %>
                                      </div>
                                    <% } %>
                                  </div>

                               
                                 
                                  


                              </td>
                                




                              </td>
                              <% const currentDate = new Date(); %>
                              <td style="width: 50px;">
                                
                             
                               
                                <%
                                let daysDifference = 0;
                              
                                if (product.receiptdate && !isNaN(new Date(product.receiptdate))) {
                                  let dateObject2 = new Date(product.receiptdate);
                                  dateObject2.setUTCHours(0, 0, 0, 0); // reset time to start of the day
                              
                                  const istOffset = 5.5 * 60 * 60 * 1000; // IST offset
                                  const currentDateMilliseconds = currentDate.getTime() + istOffset;
                                  const dateObject2Milliseconds = dateObject2.getTime();
                                  const millisecondsDifference = currentDateMilliseconds - dateObject2Milliseconds;
                              
                                  daysDifference = Math.floor(millisecondsDifference / (24 * 60 * 60 * 1000));
                                  let hoursDifference = Math.floor((millisecondsDifference % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                                  let minutesDifference = Math.floor((millisecondsDifference % (60 * 60 * 1000)) / (60 * 1000));
                                  let secondsDifference = Math.floor((millisecondsDifference % (60 * 1000)) / 1000);
                              
                                  // Optional: normalize values (though not necessary unless displaying them separately)
                                  if (secondsDifference >= 60) {
                                    minutesDifference += Math.floor(secondsDifference / 60);
                                    secondsDifference %= 60;
                                  }
                              
                                  if (minutesDifference >= 60) {
                                    hoursDifference += Math.floor(minutesDifference / 60);
                                    minutesDifference %= 60;
                                  }
                              
                                  if (hoursDifference >= 24) {
                                    daysDifference += Math.floor(hoursDifference / 24);
                                    hoursDifference %= 24;
                                  }
                                }
                              %>
                              
                              <%= daysDifference + 1 %>
                              
                              
                              
                            </td>
                            
                            <td>
                              <a href="/print3/<%= product._id %>"><i class="fa-solid fa-eye"></i></a>
                              <a href="/print/<%= product._id %>"> <i class="fa-solid fa-file-circle-check"></i></a>
                                <a href="/return/<%= product._id %>"><i class="fa-solid fa-pen-to-square"></i></a>

                                <a href="/addmoney/<%= product._id %>"><i class="fa-solid fa-money-bill"></i></a>

                           

  <!-- Your ON/OFF toggle -->
 <a href="#" class="tooltip flag-toggle" data-id="<%= product._id %>" data-flag="<%= product.flag %>">
  <i id="flag-icon-<%= product._id %>" class="fa-solid fa-flag <%= product.flag === 'on' ? 'flag-on' : '' %>"></i>
  <% if (product.flagcomment) { %>
    <span class="tooltiptext"><%= product.flagcomment %></span>
  <% } %>
</a>

<script>
  document.querySelectorAll('.flag-toggle').forEach(flagEl => {
    flagEl.addEventListener('click', async function (e) {
      e.preventDefault();

      const productId = this.getAttribute('data-id');
      const currentFlag = this.getAttribute('data-flag');
      const newFlag = currentFlag === 'on' ? 'off' : 'on';
      const icon = this.querySelector('i');

      try {
        const res = await fetch(`/api/flag/${productId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ flag: newFlag })
        });

        if (res.ok) {
          this.setAttribute('data-flag', newFlag);
          icon.classList.toggle('flag-on', newFlag === 'on');
        } else {
          alert("‚ùå Failed to update flag.");
        }
      } catch (err) {
        alert("‚ùå Network error.");
      }
    });
  });
</script>





                                
                                
                                
                                
<style>
  .flag-on {
  color: red;
  scale: 1.2;
}
/* Style for the tooltip title */
.tooltip {
  position: relative;
  display: inline-block;
}

/* Style for the tooltip text */
.tooltip .tooltiptext
 {

  visibility: hidden;
  width: 120px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}

/* Show the tooltip text when hovering over the tooltip */
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

</style>
                                
                                <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
                            
                                
                                
                                <a href="/adddropbox/<%= product._id %>">
                                  <i class="fa-brands fa-dropbox"></i>
                                </a>
                                <% if (product.receiptclientname && product.receiptclientname.phone) { %>
                                  <a href="https://wa.me/+91<%= encodeURIComponent(product.receiptclientname.phone) %>?text=Hi%20I%20am%20interested%20in%20Emerald%20Software%20Kindly%20Arrange%20Demo" target="_blank">
                                    <i class="fa-brands fa-whatsapp"></i>
                                  </a>
                                <% } else { %>
                                  <!-- Optionally, you can handle the case where the phone number is not available -->
                                  <a href="#" onclick="alert('Phone number not available'); return false;">
                                    <i class="fa-brands fa-whatsapp"></i>
                                  </a>
                                <% } %>
                                
                                
                                
                                <i class="fa-brands fa-square-whatsapp"></i>

                                <!-- Add a data attribute for the product ID and an id for easy targeting -->
<!-- Use a data attribute for the product ID -->
<i id="transportIcon-<%= product._id %>" 
  class="fa-solid fa-truck-arrow-right transport-icon <%= product.transport === 'on' ? 'flag-on' : '' %>" 
  data-id="<%= product._id %>"></i>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
 $(document).ready(function(){
   $('.transport-icon').on('click', function(e) {
     e.preventDefault();
     const icon = $(this);
     const productId = icon.data('id');
     
     // Toggle status: if icon currently has 'flag-on', set to 'off', else 'on'
     const newStatus = icon.hasClass('flag-on') ? 'off' : 'on';
     const currentTime = new Date().toISOString(); // current time in ISO format

     $.ajax({
       type: 'POST',
       url: `/transport/${productId}/toggle`,
       data: {
         transport: newStatus,
         transportdate: currentTime
       },
       success: (response) => {
         // Toggle the CSS class based on the new status
         if(newStatus === 'on'){
           icon.addClass('flag-on');
         } else {
           icon.removeClass('flag-on');
         }
         console.log('Transport status updated', response);
       },
       error: (error) => {
         console.error('Error updating transport status', error);
       }
     });
   });
 });
</script>


                                <a href="#" onclick="showConfirmation('<%= product._id %>')"><i class="fa-solid fa-trash-can"></i></a>

                              

 
                                

                                
<script>
  function showConfirmation(productId) {
    // Display a confirmation dialog
    var isConfirmed = confirm("Are you sure you want to delete this item?");

    // If the user confirms, redirect to the delete route
    if (isConfirmed) {
      window.location.href = "/deletereceipt/" + productId;
    }
  }
</script>

                                <% let totalAmount = 0; %>

                                <% product.moneyreceipt.forEach(item => { %>
                                    <% if (item.inandout === 1) { %>
                                        <% totalAmount += item.amount; %>
                                    <% } else if (item.inandout === 0) { %>
                                        <% totalAmount -= item.amount; %>
                                    <% } %>
                                <% }); %>
                                <div>
                                  <h3>Security: <%= totalAmount %></h3>
                                  <%  
                                      finalsecurity = totalAmount;
                                      let percentage = (finalAmount / finalsecurity) * 100;
                                      let warningMessage = "";
                                      let boxColor = "";
                              
                                      if (percentage > 100) {
                                          warningMessage = "Extremely Danger";
                                          boxColor = "background-color: red; color: white; font-weight: bold; padding: 5px;";
                                      } else if (percentage > 75) {
                                          warningMessage = "Danger";
                                          boxColor = "background-color: red; color: white; padding: 5px;";
                                      } else if (percentage > 50) {
                                          warningMessage = "Moderate Danger";
                                          boxColor = "background-color: yellow; color: black; padding: 5px;";
                                      }
                                  %>
                              
                                  <% if(product.final != '1'){ %>
                                  <div>Final Amount: <%= finalAmount %></div>
                                  <% if (warningMessage) { %>
                                      <div style="<%= boxColor %>"><%= warningMessage %></div>
                                  <% } %>
                                  <% } %>
                              </div>
                              
                                 
                            
                                </td>
                                <td class="security-amount hidden"><%= totalAmount %></td>
<style>
  .hidden {
    display: none;
}

</style>

                              </tr>
                                    


                              <% } %>  
                        <% }); %>
                      </tbody>
                      <h3>Final Security: <span id="finalSecurityDisplay"><%= finalsecurity %></span></h3>
                      <% if (typeof currentMonth !== 'undefined' && typeof currentYear !== 'undefined') { %>
                        <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                          <% 
                            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                            const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
                            const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
                          %>
                      
                          <a href="/ttreceiptmonthall?month=<%= prevMonth %>&year=<%= prevYear %>" class="btn btn-secondary">‚¨ÖÔ∏è Last Month</a>
                      
                          <strong>
                            <%= new Date(currentYear, currentMonth - 1).toLocaleString('default', { month: 'long', year: 'numeric' }) %>
                          </strong>
                          
                      
                          <a href="/ttreceiptmonthall?month=<%= nextMonth %>&year=<%= nextYear %>" class="btn btn-secondary">Next Month ‚û°Ô∏è</a>
                        </div>
                      <% } %>
                      
                      <% } %>     
            </table>
        </section>
    </main>
        
    
    <%- include('nav bar/navbardown.ejs') %>
   <style>
    tr {
    transition: height 0.3s ease-in-out, opacity 0.3s ease-in-out;
    /* Other styles for table rows */
}

tr.hide {
    height: 0;
    opacity: 0;
    padding: 0;
    border: 0;
}

   </style>
   <script>
    document.addEventListener('DOMContentLoaded', function() {
    recalculateFinalSecurity(); // Calculate on page load
});

function recalculateFinalSecurity() {
    let recalculatedSecurity = 0;
    const visibleRows = document.querySelectorAll('tbody tr:not(.hide)');
    
    visibleRows.forEach(row => {
        const securityCell = row.querySelector('.security-amount');
        if (securityCell) {
            const amount = parseFloat(securityCell.textContent) || 0;
            console.log(`Adding amount: ${amount}`);
            recalculatedSecurity += amount;
        }
    });

    console.log(`Final recalculated security: ${recalculatedSecurity}`);
    document.querySelector('#finalSecurityDisplay').textContent = recalculatedSecurity;
}


   
   </script>


<script>
function recalculateFinalSecurity() {
    let recalculatedSecurity = 0;
    const visibleRows = document.querySelectorAll('tbody tr:not(.hide)');
    
    visibleRows.forEach(row => {
        const securityCell = row.querySelector('.security-amount');
        if (securityCell) {
            const amount = parseFloat(securityCell.textContent) || 0;
            console.log(`Adding amount: ${amount}`);
            recalculatedSecurity += amount;
        }
    });

    console.log(`Final recalculated security: ${recalculatedSecurity}`);

    // Check if the display element exists
    const displayElement = document.querySelector('#finalSecurityDisplay');
    if (displayElement) {
        displayElement.textContent = recalculatedSecurity;
    } else {
        console.error("Display element for final security not found");
    }
}



const search = document.querySelector('.input-group input'),
      table_rows = document.querySelectorAll('tbody tr'),
      table_headings = document.querySelectorAll('thead th'),
      resultCount = document.querySelector('.result-count');

// 1. Searching for specific data of HTML table
search.addEventListener('input', searchTable);

// This function filters the table rows based on the search input value
function searchTable() {
    let matchingRows = [];
    let nonMatchingRows = [];
    let search_data = search.value.toLowerCase();

    table_rows.forEach((row, i) => {
        let table_data = row.textContent.toLowerCase();

        if (table_data.indexOf(search_data) >= 0) {
            matchingRows.push(row);
        } else {
            nonMatchingRows.push(row);
        }

        row.classList.toggle('hide', table_data.indexOf(search_data) < 0);
        row.style.setProperty('--delay', i / 25 + 's');
    });

    let combinedRows = matchingRows.concat(nonMatchingRows);
    let tbody = document.querySelector('tbody');
    tbody.innerHTML = '';
    combinedRows.forEach(row => tbody.appendChild(row));

    document.querySelectorAll('tbody tr:not(.hide)').forEach((visible_row, i) => {
        visible_row.style.backgroundColor = (i % 2 == 0) ? 'transparent' : '#0000000b';
    });

    resultCount.textContent = `Found ${matchingRows.length} from ${table_rows.length} entries`;

    window.scrollTo(0, document.querySelector('table').offsetTop);

    // Recalculate the final security amount after the table is filtered
    recalculateFinalSecurity(); // Ensure this is called at the right time
}

// Attach click event handlers to table headings for sorting
table_headings.forEach((head, i) => {
    let sort_asc = true;
    head.onclick = () => {
        // Remove 'active' class from all table headings, then add it to the clicked heading
        table_headings.forEach(head => head.classList.remove('active'));
        head.classList.add('active');

        // Remove 'active' class from all table cells, then add it to the corresponding cells in each row
        document.querySelectorAll('td').forEach(td => td.classList.remove('active'));
        table_rows.forEach(row => {
            row.querySelectorAll('td')[i].classList.add('active');
        });

        // Toggle 'asc' class and update sort order variable
        head.classList.toggle('asc', sort_asc);
        sort_asc = head.classList.contains('asc') ? false : true;

        // Call the sortTable function to perform sorting
        sortTable(i, sort_asc, head.dataset.sortType);
    };
});

function sortTable(column, sort_asc, sortType) {
    [...table_rows].sort((a, b) => {
        let first_row = a.querySelectorAll('td')[column].textContent.toLowerCase();
        let second_row = b.querySelectorAll('td')[column].textContent.toLowerCase();

        if (sortType === 'numeric') {
            // Convert text to numbers for numerical sorting
            first_row = parseFloat(first_row);
            second_row = parseFloat(second_row);
        }

        return sort_asc ? (first_row > second_row ? 1 : -1) : (first_row > second_row ? -1 : 1);
    })
    .map(sorted_row => document.querySelector('tbody').appendChild(sorted_row));
}
</script>
<script>
function confirmDelete(postId) {
    var confirmation = confirm("Are you sure you want to delete this item?");
    if (confirmation) {
        // User clicked "OK", proceed with deletion
        window.location.href = "/deleteitem/" + postId;
    } else {
        // User clicked "Cancel", do nothing
    }
}
</script>
<style>
.red-icon {
  color: red;
}

   i {
  color: rgb(0, 119, 255); /* Change the color as needed */
  font-size: 22px; /* Adjust the font size as needed */
  /* Add more styles as per your requirements */
}
i.fa-trash-can {
  color: rgb(213, 3, 3); /* Change the color as needed */
  font-size: 22px; /* Adjust the font size as needed */
  /* Add more styles as per your requirements */
}

   .item-container {
  display: flex;
  flex-direction: column;
  background: #efefef;
}

.item-header , .item-row {
  display: flex;
}

.item-header div, .item-row div {
  flex: 1;
  padding: 8px;
  border: 1px solid #908f8f;
}

.item-header ,.item-row div {
  text-align: center;
}

.item-row div[colspan="3"] {
  flex: 3;

}



</style>